# LGTM (Loki, Grafana, Tempo, Mimir/Prometheus) Stack for Kubernetes
# OpenTelemetry 백엔드 - 개발/테스트 환경용
---
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
---
# Service를 UI와 OTLP로 분리하는 이유:
# 1. UI (3000): 사람이 브라우저로 접속 → Ingress를 통한 도메인 기반 접근 (ClusterIP)
# 2. OTLP (4317, 4318): 애플리케이션이 텔레메트리 데이터 전송 → NodePort로 직접 접근
# 용도가 다르므로 논리적으로 분리하여 보안성과 관리 효율성 향상
# Grafana UI 서비스 (ClusterIP - Ingress 전용)
apiVersion: v1
kind: Service
metadata:
  name: lgtm-ui
  namespace: monitoring
spec:
  type: ClusterIP
  selector:
    app: lgtm
  ports:
    - name: grafana
      protocol: TCP
      port: 3000
      targetPort: 3000
---
# OpenTelemetry 데이터 수신 서비스 (NodePort - 직접 접근)
apiVersion: v1
kind: Service
metadata:
  name: lgtm-otlp
  namespace: monitoring
spec:
  type: NodePort
  selector:
    app: lgtm
  ports:
    - name: otel-grpc
      protocol: TCP
      port: 4317
      targetPort: 4317
      nodePort: 30317  # OpenTelemetry gRPC 수신: http://<node-ip>:30317
    - name: otel-http
      protocol: TCP
      port: 4318
      targetPort: 4318
      nodePort: 30318  # OpenTelemetry HTTP 수신: http://<node-ip>:30318
---
# Grafana UI를 도메인으로 접근하기 위한 Ingress 설정
# http://grafana.dead-whale.org → Grafana UI (포트 없이 접근)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: lgtm-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"  # HTTP 허용 (필요시 true로 변경)
spec:
  ingressClassName: nginx
  rules:
    - host: grafana.dead-whale.org
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: lgtm-ui
                port:
                  number: 3000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lgtm
  namespace: monitoring
  annotations:
    # ArgoCD가 헬스 체크를 너무 빨리 포기하지 않도록 설정
    argocd.argoproj.io/sync-options: Validate=false
spec:
  strategy:
    type: Recreate # PVC 연결 문제 방지를 위해 롤링 업데이트 대신 재생성 권장
  selector:
    matchLabels:
      app: lgtm
  template:
    metadata:
      labels:
        app: lgtm
    spec:
      # [중요] 권한 문제 방지를 위한 보안 컨텍스트 (K3s 환경 대응)
      securityContext:
        fsGroup: 472 # Grafana user ID
        runAsUser: 472
        runAsGroup: 472
      containers:
        - name: lgtm
          image: grafana/otel-lgtm:latest
          imagePullPolicy: Always # 개발용 이미지라 latest가 자주 바뀌니 Always 권장
          ports:
            - containerPort: 3000
            - containerPort: 4317
            - containerPort: 4318
          env:
            # --- 필수 디버깅 옵션 ---
            # 데이터 안 들어올 때 이 로그 없으면 멘붕 옴
            - name: ENABLE_LOGS_OTELCOL
              value: "true"
            - name: ENABLE_LOGS_GRAFANA
              value: "true"
            - name: ENABLE_LOGS_PROMETHEUS
              value: "true"
            - name: ENABLE_LOGS_LOKI
              value: "true"
            - name: ENABLE_LOGS_TEMPO
              value: "true"
            # --- Grafana 설정 ---
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "false"
            - name: GF_SERVER_ROOT_URL
              value: "https://grafana.dead-whale.org" # https로 변경 (Ingress TLS 사용 시)
            - name: GF_AUTH_GITHUB_ENABLED
              value: "true"
            - name: GF_AUTH_GITHUB_CLIENT_ID
              value: "Ov23liBH6Aks2u0iOs1G"
            - name: GF_AUTH_GITHUB_ALLOWED_ORGANIZATIONS
              value: "bottle-note"
            - name: GF_AUTH_GITHUB_ROLE_ATTRIBUTE_PATH
              value: "[login=='Whale0928'][0] && 'Admin' || 'Viewer'"
          envFrom:
            - secretRef:
                name: monitoring-secret
          # [중요] ArgoCD가 "Healthy"라고 판단하는 기준점
          # 단순히 포트 열림(tcpSocket)이 아니라 실제 API 응답을 확인해야 함
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 60 # 프로세스 5개 뜨느라 오래 걸림. 넉넉히 줄 것
            periodSeconds: 10
            failureThreshold: 5
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 120
            periodSeconds: 20
          resources:
            requests:
              memory: "2Gi" # 이거보다 적으면 OOM으로 죽을 확률 90%
              cpu: "1000m"
            limits:
              memory: "4Gi"
              cpu: "2000m"
          volumeMounts:
            - name: grafana-storage
              mountPath: /data/grafana
            - name: loki-storage
              mountPath: /data/loki
            - name: tempo-storage
              mountPath: /data/tempo
            - name: p8s-storage
              mountPath: /data/prometheus
      volumes:
        # (마운트 설정은 기존 유지 - 호스트 패스)
        - name: grafana-storage
          hostPath: { path: /mnt/data/lgtm/grafana, type: DirectoryOrCreate }
        - name: loki-storage
          hostPath: { path: /mnt/data/lgtm/loki, type: DirectoryOrCreate }
        - name: tempo-storage
          hostPath: { path: /mnt/data/lgtm/tempo, type: DirectoryOrCreate }
        - name: p8s-storage
          hostPath: { path: /mnt/data/lgtm/prometheus, type: DirectoryOrCreate }
